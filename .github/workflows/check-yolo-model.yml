name: VÃ©rification du modÃ¨le YOLO

on:
  push:
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  check-yolo-model:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout du code
      uses: actions/checkout@v4
      
    - name: VÃ©rification du modÃ¨le YOLO dans le code
      run: |
        echo "ðŸ¤– VÃ©rification du modÃ¨le YOLO utilisÃ©"
        echo "====================================="
        echo ""
        
        # Chercher tous les fichiers Python
        python_files=$(find . -name "*.py" -type f | grep -v __pycache__)
        
        if [ -z "$python_files" ]; then
          echo "âŒ Aucun fichier Python trouvÃ©"
          exit 1
        fi
        
        echo "ðŸ“‹ Fichiers Python Ã  analyser:"
        echo "$python_files"
        echo ""
        
        # VÃ©rifier la prÃ©sence de yolo11n.pt
        echo "ðŸ” Recherche du modÃ¨le YOLO11n.pt..."
        
        yolo11n_found=false
        other_models_found=false
        
        for file in $python_files; do
          echo "ðŸ“„ Analyse de: $file"
          
          # Chercher yolo11n.pt (case insensitive)
          if grep -i "yolo11n\.pt" "$file" >/dev/null 2>&1; then
            echo "  âœ… yolo11n.pt trouvÃ© !"
            yolo11n_found=true
            
            # Afficher les lignes contenant le modÃ¨le
            echo "  ðŸ“ Lignes trouvÃ©es:"
            grep -n -i "yolo11n\.pt" "$file" | sed 's/^/    /'
          fi
          
          # Chercher d'autres modÃ¨les YOLO
          if grep -E "(yolo11[smlx]\.pt|yolo8|yolo5|yolov)" "$file" >/dev/null 2>&1; then
            echo "  âš ï¸  Autres modÃ¨les YOLO dÃ©tectÃ©s:"
            grep -n -E "(yolo11[smlx]\.pt|yolo8|yolo5|yolov)" "$file" | sed 's/^/    /'
            other_models_found=true
          fi
          
          echo ""
        done
        
        echo "ðŸ“Š RÃ©sumÃ© de la vÃ©rification:"
        echo "=========================="
        
        if [ "$yolo11n_found" = true ]; then
          echo "âœ… YOLO11n.pt correctement utilisÃ©"
        else
          echo "âŒ YOLO11n.pt NON trouvÃ© dans le code"
        fi
        
        if [ "$other_models_found" = true ]; then
          echo "âš ï¸  D'autres modÃ¨les YOLO ont Ã©tÃ© dÃ©tectÃ©s"
        else
          echo "âœ… Aucun autre modÃ¨le YOLO dÃ©tectÃ©"
        fi
        
        # Ã‰chec si yolo11n.pt n'est pas trouvÃ©
        if [ "$yolo11n_found" = false ]; then
          echo ""
          echo "âŒ ERREUR: Le modÃ¨le YOLO11n.pt n'est pas utilisÃ© !"
          echo "ðŸ“‹ ModÃ¨les recommandÃ©s par ordre de prioritÃ©:"
          echo "  1. yolo11n.pt (nano - recommandÃ© pour temps rÃ©el)"
          echo "  2. yolo11s.pt (small - bon compromis)"
          echo "  3. yolo11m.pt (medium - plus prÃ©cis)"
          exit 1
        fi
        
        echo ""
        echo "ðŸŽ‰ VÃ©rification du modÃ¨le YOLO rÃ©ussie !"
        
    - name: VÃ©rification de la syntaxe d'importation YOLO
      run: |
        echo "ðŸ“¦ VÃ©rification de l'importation YOLO"
        echo "====================================="
        
        # Chercher les imports YOLO
        echo "ðŸ” Recherche des imports YOLO..."
        
        import_found=false
        correct_import=false
        
        for file in $(find . -name "*.py" -type f | grep -v __pycache__); do
          echo "ðŸ“„ VÃ©rification des imports dans: $file"
          
          # Chercher l'import YOLO
          if grep "from ultralytics import YOLO" "$file" >/dev/null 2>&1; then
            echo "  âœ… Import YOLO correct trouvÃ©"
            import_found=true
            correct_import=true
            grep -n "from ultralytics import YOLO" "$file" | sed 's/^/    /'
          elif grep "import.*YOLO" "$file" >/dev/null 2>&1; then
            echo "  âš ï¸  Import YOLO trouvÃ© (mais vÃ©rifier la syntaxe)"
            import_found=true
            grep -n "import.*YOLO" "$file" | sed 's/^/    /'
          fi
          echo ""
        done
        
        echo "ðŸ“Š RÃ©sumÃ© des imports:"
        if [ "$correct_import" = true ]; then
          echo "âœ… Import YOLO correct: 'from ultralytics import YOLO'"
        elif [ "$import_found" = true ]; then
          echo "âš ï¸  Import YOLO trouvÃ© mais Ã  vÃ©rifier"
        else
          echo "âŒ Aucun import YOLO trouvÃ©"
          echo "ðŸ’¡ Import recommandÃ©: 'from ultralytics import YOLO'"
        fi
        
    - name: VÃ©rification de l'initialisation du modÃ¨le
      run: |
        echo "âš™ï¸  VÃ©rification de l'initialisation du modÃ¨le"
        echo "=============================================="
        
        # Chercher l'initialisation YOLO
        echo "ðŸ” Recherche de l'initialisation YOLO('yolo11n.pt')..."
        
        init_found=false
        
        for file in $(find . -name "*.py" -type f | grep -v __pycache__); do
          echo "ðŸ“„ VÃ©rification dans: $file"
          
          # Chercher YOLO("yolo11n.pt")
          if grep -E 'YOLO\s*\(\s*["\']yolo11n\.pt["\']' "$file" >/dev/null 2>&1; then
            echo "  âœ… Initialisation correcte trouvÃ©e !"
            init_found=true
            grep -n -E 'YOLO\s*\(\s*["\']yolo11n\.pt["\']' "$file" | sed 's/^/    /'
          fi
          
          # Chercher d'autres initialisations YOLO
          if grep -E 'YOLO\s*\(' "$file" >/dev/null 2>&1; then
            echo "  ðŸ“ Initialisations YOLO trouvÃ©es:"
            grep -n -E 'YOLO\s*\(' "$file" | sed 's/^/    /'
          fi
          echo ""
        done
        
        if [ "$init_found" = true ]; then
          echo "âœ… Initialisation YOLO('yolo11n.pt') correcte"
        else
          echo "âš ï¸  Initialisation YOLO('yolo11n.pt') non trouvÃ©e explicitement"
          echo "ðŸ’¡ Pattern attendu: model = YOLO('yolo11n.pt')"
        fi
        
    - name: GÃ©nÃ©ration du rapport de vÃ©rification YOLO
      run: |
        echo "ðŸ“‹ GÃ©nÃ©ration du rapport de vÃ©rification"
        echo "======================================="
        
        echo "# ðŸ¤– Rapport de vÃ©rification modÃ¨le YOLO" > yolo_check_report.md
        echo "" >> yolo_check_report.md
        echo "## ðŸ“Š RÃ©sumÃ©" >> yolo_check_report.md
        echo "- **Date**: $(date)" >> yolo_check_report.md
        echo "- **Branche**: ${{ github.ref_name }}" >> yolo_check_report.md
        echo "- **Commit**: ${{ github.sha }}" >> yolo_check_report.md
        echo "" >> yolo_check_report.md
        
        echo "## âœ… VÃ©rifications effectuÃ©es" >> yolo_check_report.md
        echo "1. **PrÃ©sence du modÃ¨le yolo11n.pt** dans le code" >> yolo_check_report.md
        echo "2. **Import YOLO** correct depuis ultralytics" >> yolo_check_report.md
        echo "3. **Initialisation du modÃ¨le** YOLO" >> yolo_check_report.md
        echo "4. **DÃ©tection d'autres modÃ¨les** non recommandÃ©s" >> yolo_check_report.md
        echo "" >> yolo_check_report.md
        
        echo "## ðŸŽ¯ ModÃ¨le recommandÃ©" >> yolo_check_report.md
        echo "- **yolo11n.pt** (YOLO11 Nano)" >> yolo_check_report.md
        echo "- Taille: ~6 MB" >> yolo_check_report.md
        echo "- Performance: OptimisÃ©e pour temps rÃ©el" >> yolo_check_report.md
        echo "- PrÃ©cision: Bonne pour la dÃ©tection gÃ©nÃ©rale" >> yolo_check_report.md
        echo "" >> yolo_check_report.md
        
        echo "## ðŸ“ Fichiers analysÃ©s" >> yolo_check_report.md
        echo '```' >> yolo_check_report.md
        find . -name "*.py" -type f | grep -v __pycache__ >> yolo_check_report.md
        echo '```' >> yolo_check_report.md
        
        echo "ðŸ“„ Contenu du rapport:"
        cat yolo_check_report.md
        
    - name: Upload du rapport YOLO
      uses: actions/upload-artifact@v3
      with:
        name: yolo-model-check-report
        path: yolo_check_report.md
