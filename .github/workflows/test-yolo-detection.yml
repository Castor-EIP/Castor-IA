name: Test et validation du systÃ¨me de dÃ©tection YOLO

on:
  push:
    branches: [ main, master ]
    paths: 
      - 'ai/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'ai/**'
  workflow_dispatch:

jobs:
  validate-yolo-detection:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout du code
      uses: actions/checkout@v4
      
    - name: Configuration de Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Cache des dÃ©pendances pip
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Installation des dÃ©pendances systÃ¨me
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-glx libglib2.0-0 libsm6 libxext6 libxrender-dev libgomp1
        
    - name: Installation des dÃ©pendances Python
      run: |
        python -m pip install --upgrade pip
        pip install ultralytics opencv-python numpy pytest
        
    - name: VÃ©rification de la structure du projet
      run: |
        echo "ðŸ” VÃ©rification de la structure du projet..."
        if [ ! -f "ai/body_tracking.py" ]; then
          echo "âŒ Le fichier ai/body_tracking.py est manquant"
          exit 1
        fi
        echo "âœ… Structure du projet validÃ©e"
        
    - name: Validation de la syntaxe Python
      run: |
        echo "ðŸ Validation de la syntaxe Python..."
        python -m py_compile ai/body_tracking.py
        echo "âœ… Syntaxe Python validÃ©e"
        
    - name: Test des imports et dÃ©pendances
      run: |
        echo "ðŸ“¦ Test des imports..."
        python -c "
        try:
            from ultralytics import YOLO
            import cv2
            import numpy as np
            print('âœ… Tous les imports sont disponibles')
        except ImportError as e:
            print(f'âŒ Erreur d'import: {e}')
            exit(1)
        "
        
    - name: Validation du modÃ¨le YOLO
      run: |
        echo "ðŸ¤– Test de chargement du modÃ¨le YOLO..."
        python -c "
        from ultralytics import YOLO
        try:
            model = YOLO('yolo11n.pt')
            print('âœ… ModÃ¨le YOLO chargÃ© avec succÃ¨s')
            print(f'ðŸ“Š Classes disponibles: {len(model.names)} classes')
            
            # VÃ©rifier la prÃ©sence de la classe 'cell phone'
            if 'cell phone' in model.names.values():
                print('âœ… Classe \"cell phone\" trouvÃ©e dans le modÃ¨le')
            else:
                print('âš ï¸  Classe \"cell phone\" non trouvÃ©e')
                print(f'Classes disponibles: {list(model.names.values())}')
        except Exception as e:
            print(f'âŒ Erreur lors du chargement du modÃ¨le: {e}')
            exit(1)
        "
        
    - name: Test de validation du code (sans camÃ©ras)
      run: |
        echo "ðŸ§ª Test de validation du code principal..."
        python -c "
        import sys
        import os
        sys.path.append('ai')
        
        # Test de validation sans exÃ©cution complÃ¨te
        from ultralytics import YOLO
        import cv2
        import numpy as np
        
        print('âœ… Test de base rÃ©ussi')
        
        # Simulation d'une frame de test
        model = YOLO('yolo11n.pt')
        test_frame = np.zeros((480, 640, 3), dtype=np.uint8)
        
        try:
            results = model(test_frame)
            annotated_frame = results[0].plot()
            print('âœ… Pipeline de dÃ©tection fonctionnel')
        except Exception as e:
            print(f'âŒ Erreur dans le pipeline: {e}')
            exit(1)
        "
        
    - name: Analyse de la qualitÃ© du code
      run: |
        echo "ðŸ“Š Analyse de la qualitÃ© du code..."
        pip install flake8
        
        # Ignorer certaines erreurs spÃ©cifiques Ã  OpenCV et YOLO
        flake8 ai/body_tracking.py --max-line-length=100 --ignore=E501,W503 || echo "âš ï¸  Quelques avertissements de style dÃ©tectÃ©s"
        
    - name: GÃ©nÃ©ration du rapport de test
      run: |
        echo "ðŸ“‹ GÃ©nÃ©ration du rapport de test..."
        echo "## ðŸŽ¯ Rapport de validation YOLO Detection" > test_report.md
        echo "" >> test_report.md
        echo "### âœ… Tests rÃ©ussis:" >> test_report.md
        echo "- Structure du projet validÃ©e" >> test_report.md
        echo "- Syntaxe Python correcte" >> test_report.md
        echo "- DÃ©pendances installÃ©es" >> test_report.md
        echo "- ModÃ¨le YOLO fonctionnel" >> test_report.md
        echo "- Pipeline de dÃ©tection opÃ©rationnel" >> test_report.md
        echo "" >> test_report.md
        echo "### ðŸ“Š Informations systÃ¨me:" >> test_report.md
        echo "- Python: $(python --version)" >> test_report.md
        echo "- OpenCV: $(python -c 'import cv2; print(cv2.__version__)')" >> test_report.md
        echo "- NumPy: $(python -c 'import numpy; print(numpy.__version__)')" >> test_report.md
        echo "- Date: $(date)" >> test_report.md
        
        cat test_report.md
        
    - name: Upload du rapport
      uses: actions/upload-artifact@v3
      with:
        name: test-report
        path: test_report.md
